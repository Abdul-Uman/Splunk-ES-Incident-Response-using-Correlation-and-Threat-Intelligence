## Introduction

In this guide, you will learn how to set up a correlation search in Splunk ES to detect a **Large Number of Inbound Firewall Deny connections from the same source IP**. We will use various **threat intelligence tools** to analyze the source IP and determine the appropriate response.

## Creating the Correlation Search

1. **Open Splunk ES** and navigate to the **Configure** menu.

![Screenshot 2024-08-15 123034](https://github.com/user-attachments/assets/b5c13e1d-5f9b-4abb-ad2d-4ce80f7f83ee)

   
2. Select **Content Management**.

![Screenshot 2024-08-15 123127](https://github.com/user-attachments/assets/5462f39b-63b7-4752-bd2a-b6ae36316704)

  
3. Click on **New Content** and choose **Correlation Search**.

![Screenshot 2024-08-15 123342](https://github.com/user-attachments/assets/96459461-5470-4db7-8bf7-1ac691c18573)


4. **Configure the Correlation Search**:
   - **Query**: Write the SPL (Search Processing Language) query to identify the Firewall Deny events.

![Screenshot 2024-08-15 132341](https://github.com/user-attachments/assets/99af535b-b16a-4045-abd7-3944323d2c15)


   - **Time Range**: Set the appropriate time range for monitoring.

![Screenshot 2024-08-15 132356](https://github.com/user-attachments/assets/938b694f-e41c-4cae-bcc5-c6901fb80dba)
   
   
   - **Throttling**: Configure throttling to avoid duplicate alerts.

![Screenshot 2024-08-15 132440](https://github.com/user-attachments/assets/acc748d3-2fb4-44bb-b2f9-bc982b1a550a)

     
   - **Notable and Drilldown**: Define the notable event actions and drilldown search.

![Screenshot 2024-08-15 132708](https://github.com/user-attachments/assets/e8226ceb-d01c-4956-86d6-191ccacd9659)


7. **Save** the correlation search.

## Incident Review and Response

### Analyzing Historical Events

1. **Review the Alerts** generated by the correlation search in the Incident Review dashboard.

![Screenshot 2024-08-16 124116](https://github.com/user-attachments/assets/5cb7161a-7589-4c44-8753-a861b1f18252)


2. **Contributing Events**: For each alert, Collect Matching Event Data

![Screenshot 2024-08-16 124221](https://github.com/user-attachments/assets/9266c8fc-d57c-45d5-9ed6-96f06032e15a)

3.  Download **Matching Events** as a **CSV file** for further analysis.

![Screenshot 2024-08-16 124632](https://github.com/user-attachments/assets/60d588b3-2527-43b7-9531-88bcd2b2a0c6)

4. Create it in a manner **Readable and Easy to Understand**

![Screenshot 2024-08-16 131601](https://github.com/user-attachments/assets/48f52d52-3d26-40cd-ad4e-3740487d6e26)

   
### Threat Intelligence Check

1. **Analyze the Source IP**:
   - Check the IP's reputation, blacklist status, and location.
   - Determine if the IP is involved in any known malicious activities.
     
2. **Use Threat Intelligence Tools** such as:
   - Analyzing using **Cisco Talos Intelligence**

![Screenshot 2024-08-16 123437](https://github.com/user-attachments/assets/deb67cdb-6794-497d-a0ee-d0a20905a54b)

     
   - Analyzing using **MXToolbox**

![Screenshot 2024-08-16 123206](https://github.com/user-attachments/assets/af8ba8e5-687c-4388-b9c2-fc46b5a4f2f5)

     
   - Analyzing using **IPVoid**

![Screenshot 2024-08-16 123334](https://github.com/user-attachments/assets/6f9ad2d2-146b-4990-a60c-8e11724dc438)

     
   - Analyzing using **WhoisDomainTools.com**

![Screenshot 2024-08-16 123324](https://github.com/user-attachments/assets/f0929f7f-bbad-4265-85f0-a3ba0f0777e5)


### ServiceNow Ticketing

**Description**: This section covers the steps to communicate with relevant teams and manage incidents using ServiceNow.

1. **Create a ServiceNow Ticket** to document the incident by creating a ticket in the ServiceNow platform.

 - Select **Start Building**

![Screenshot 2024-08-23 232153](https://github.com/user-attachments/assets/7db0cc02-aed7-4c90-8845-1d45210dae5a)


 - Navigate to **All**
 - Select **Incindents**

![Screenshot 2024-08-16 140101](https://github.com/user-attachments/assets/89884c27-5d27-49f1-b25b-5d07eb1b5cd4)

  - Fill the **Information about Incident with Attachment of Downloaded CSV file**

![Screenshot 2024-08-16 140537](https://github.com/user-attachments/assets/0a7e7318-1b89-4739-997c-7f84a929bf55)


### Email Communication

1. **Send an Email** to the relevant team, including the ServiceNow ticket , Matching Event details , Threat Intelligence Data to the respective team which conatins all information about Incident, asking them to take action.

![Screenshot 2024-08-24 160938](https://github.com/user-attachments/assets/bd3635c4-9e99-44c7-8357-ef0dee35705b)


![Screenshot 2024-08-16 141013](https://github.com/user-attachments/assets/cf9ea8fd-8c20-4d8f-a695-416145b67b83)


![Screenshot 2024-08-16 141025](https://github.com/user-attachments/assets/b3668d3d-351c-4389-a605-ac23c328ab9b)


![Screenshot 2024-08-24 162131](https://github.com/user-attachments/assets/13811c15-5e21-488b-841d-ee731d79f37e)


### Blocking the Source IP

- As the Incident is **true positive**, proceed to **block the source IP** on the firewall to prevent further malicious activity.
